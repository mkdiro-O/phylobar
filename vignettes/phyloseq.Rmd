---
title: "`phyloseq` examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data_prep}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    message = FALSE,
    warning = FALSE
)
```

```{r setup}
library(ape)
library(phangorn)
library(phylobar)
library(phyloseq)
library(purrr)
```

## `phyloseq` example

```{r}
data(GlobalPatterns)
chlamydiae <- subset_taxa(GlobalPatterns, Phylum == "Chlamydiae")

x <- t(otu_table(chlamydiae))
tree <- phy_tree(chlamydiae)
x[rowSums(x) == 0, 1] <- 1
x <- x / rowSums(x)
phylobar(x, tree, width = 900)
```

This creates the same type of visualization but using a taxonomic hierarchy
rather than a phylogeny.  We have some problem specific preprocessing to deal
with the fact that some ancestor and descendant names look identical in this
dataset for some reason.

```{r}
taxa <- tax_table(chlamydiae) |>
    as.data.frame()
taxa$ASV <- rownames(taxa)
ranks <- c(rank_names(chlamydiae), "ASV")
edges <- list()

for (j in seq_len(ncol(taxa) - 1)) {
    prefix <- paste0(substr(colnames(taxa)[j], 1, 1), "_")
    taxa[, j] <- ifelse(is.na(taxa[, j]), NA, paste0(prefix, taxa[, j]))
}
```

Now we can make the visualization.

```{r}
tax_tree <- taxonomy_to_tree(taxa)
phylobar(x, tax_tree, width = 900)
```
```{r}
sessionInfo()
```