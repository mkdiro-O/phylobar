---
title: "stream-test"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{stack-test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    warning = FALSE,
    message = FALSE
)
```

```{r setup}
library(jsonlite)
library(phylobar)
library(tidyverse)
```

```{r}
smooth_time_series <- function(df, time_col = "timepoint", pseudocount = 1, round_degree = 2, bandwidth = 5) {
    # Round timepoints
    df <- df |>
        mutate(time_bin = round_degree * round(.data[[time_col]] / round_degree)) |>
        arrange(time_bin) |>
        group_by(time_bin) |>
        summarise(
            value = (sum(value) + pseudocount) / (n() + pseudocount)
        )
    
    # Fill gaps with 0
    tibble(time_bin = seq(min(df$time_bin), max(df$time_bin), by = round_degree)) |>
        left_join(df, by = "time_bin") |>
        mutate(value = replace_na(value, 0)) |>
        reframe(
            smooth_value = ksmooth(time_bin, value, "normal", bandwidth, n.points = n())$y,
            time_bin = ksmooth(time_bin, value, "normal", bandwidth, n.points = n())$x
        )
}
```

For data cleaning, it will be helpful to have the phyloseq components as data.frames.

```{r}
ps <- readRDS("vignettes/zhang2023-ps.rds")
x_mat <- t(otu_table(ps)) |>
    data.frame() |>
    rownames_to_column("sample")
metadata <- sample_data(ps) |>
    as.data.frame() |>
    rownames_to_column("sample")
```

```{r}
x_smooth <- x_mat |>
    left_join(metadata, by = "sample") |>
    filter(timepoint >= -5, timepoint <= 55) |>
    select(id, timepoint, starts_with("OTU")) |>
    pivot_longer(starts_with("O"), names_to = "feature", values_to = "value") |>
    group_by(feature) |>
    group_modify(~ smooth_time_series(.x)) |>
    pivot_wider(names_from = feature, values_from = smooth_value) |>
    column_to_rownames("time_bin")
```

## Phylobar Visualization

```{r, out.width = 900}
x_smooth <- x_smooth / rowSums(x_smooth)
phylobar(x_smooth, phy_tree(ps), width = 900, hclust_order = FALSE)
```

```{r}
sessionInfo()
```